# ==============================================================================
#  Arch Linux Full Install (Willem Edition)
#  Secure + ext4 + LUKS2 + TPM2 + Secure Boot + Plymouth
# ==============================================================================

# -------------------------------------------------------------------------
# 0  Wipe the target SSD (NVMe) – start from a clean slate
# -------------------------------------------------------------------------

DISK=/dev/nvme0n1

wipefs --all --force "$DISK"
sgdisk --zap-all "$DISK"
partprobe "$DISK"


# -------------------------------------------------------------------------
# 1   Partitioning (GPT)
#     • 512 MiB EFI System Partition (UEFI & Secure Boot)
#     • Remainder = Encrypted root (ext4)
# -------------------------------------------------------------------------

sgdisk --new=1:0:+512MiB --typecode=1:EF00 --change-name=1:"EFI System Partition" "$DISK"
sgdisk --new=2:0:0       --typecode=2:8300 --change-name=2:"Encrypted Root"       "$DISK"
partprobe "$DISK"


# -------------------------------------------------------------------------
# 2  LUKS2 encryption (TPM + PIN)
# -------------------------------------------------------------------------

ROOT_PART="${DISK}p2"

cryptsetup luksFormat "$ROOT_PART" \
  --type luks2 \
  --cipher aes-xts-plain64 \
  --key-size 512 \
  --hash sha512 \
  --pbkdf argon2id \
  --pbkdf-memory 524288 \
  --pbkdf-time 2000 \
  --label cryptroot

cryptsetup open "$ROOT_PART" cryptroot   # creates /dev/mapper/cryptroot


# -------------------------------------------------------------------------
# 3  Filesystems
# -------------------------------------------------------------------------

mkfs.fat -F32 -n ESP "${DISK}p1"                     # EFI – FAT32
mkfs.ext4 -L archroot /dev/mapper/cryptroot         # Root – plain ext4


# -------------------------------------------------------------------------
# 4  Mount the new system
# -------------------------------------------------------------------------

mount /dev/mapper/cryptroot /mnt
mkdir -p /mnt/boot
mount "${DISK}p1" /mnt/boot


# -------------------------------------------------------------------------
# 5  Time & localisation (still useful before pacstrap)
# -------------------------------------------------------------------------

timedatectl set-ntp true
timedatectl set-timezone Europe/Amsterdam


# -------------------------------------------------------------------------
# 6  Pacman configuration – speed things up & get good mirrors
# -------------------------------------------------------------------------

sed -i \
  -e 's/^ParallelDownloads =.*/ParallelDownloads = 20/' \
  -e 's/^#Color/Color/' \
  -e '/^#\[multilib\]/,/^#Include = \/etc\/pacman.d\/mirrorlist/ s/^#//' \
  /etc/pacman.conf

reflector --country Netherlands,Germany --age 10 --protocol https --sort rate \
  --save /etc/pacman.d/mirrorlist


# -------------------------------------------------------------------------
# 7  Install the base system + minimal Hyprland stack
# -------------------------------------------------------------------------

pacstrap -K /mnt \
  base base-devel linux linux-firmware linux-headers \
  cryptsetup mkinitcpio \
  sbctl sbsigntools efibootmgr \
  tpm2-tss tpm2-tools \
  amd-ucode \
  apparmor nftables usbguard \
  networkmanager iwd \
  sudo git neovim man-db reflector \
  alacritty zsh zsh-completions zsh-autosuggestions \
  binutils inotify-tools \
  plymouth \
  bluez bluez-utils \
  pipewire pipewire-alsa pipewire-pulse pipewire-jack wireplumber \
  mesa vulkan-radeon libva-mesa-driver lib32-mesa lib32-vulkan-radeon lib32-libva-mesa-driver \
  hyprland hyprcursor hypridle hyprlock \
  xdg-desktop-portal-hyprland \
  qt5-wayland qt6-wayland \
  polkit-gnome dunst \
  xdg-user-dirs xdg-utils \
  waybar wofi \
  grim slurp swappy


# -------------------------------------------------------------------------
# 8  Generate fstab and chroot
# -------------------------------------------------------------------------

genfstab -U /mnt >> /mnt/etc/fstab

arch-chroot /mnt


# -------------------------------------------------------------------------
# 8.0 Environment Variables
# -------------------------------------------------------------------------

cat <<EOF > /etc/environment
TERMINAL=alacritty
EDITOR=nvim
VISUAL=nvim
SHELL=/usr/bin/zsh
MOZ_ENABLE_WAYLAND=1
QT_QPA_PLATFORM=wayland
SDL_VIDEODRIVER=wayland
EOF


# -------------------------------------------------------------------------
# 9  Pacman & Mirrors (inside chroot)
# -------------------------------------------------------------------------

timedatectl set-ntp true
ln -sf /usr/share/zoneinfo/Europe/Amsterdam /etc/localtime
hwclock --systohc

sed -i \
  -e 's/^ParallelDownloads =.*/ParallelDownloads = 20/' \
  -e 's/^#Color/Color/' \
  -e '/^#\[multilib\]/,/^#Include = \/etc\/pacman.d\/mirrorlist/ s/^#//' \
  /etc/pacman.conf

reflector --country Netherlands,Germany --age 10 --protocol https --sort rate \
  --save /etc/pacman.d/mirrorlist

pacman -Syu --noconfirm


# -------------------------------------------------------------------------
# 10  Essential Services
# -------------------------------------------------------------------------

systemctl enable systemd-timesyncd
systemctl enable reflector.timer
systemctl enable fstrim.timer
systemctl enable apparmor
systemctl enable NetworkManager
systemctl enable usbguard
systemctl enable nftables
systemctl enable bluetooth

cat <<EOF > /etc/NetworkManager/NetworkManager.conf
[device]
wifi.backend=iwd
EOF

plymouth-set-default-theme -R spinner


# -------------------------------------------------------------------------
# 11  Localization & Keyboard
# -------------------------------------------------------------------------

sed -i '/^#en_US.UTF-8 UTF-8/s/^#//' /etc/locale.gen
locale-gen

echo "LANG=en_US.UTF-8" > /etc/locale.conf
echo "KEYMAP=us" > /etc/vconsole.conf


# -------------------------------------------------------------------------
# 12  Hostname & Hosts
# -------------------------------------------------------------------------

echo Arch-WA > /etc/hostname
cat <<'EOF' > /etc/hosts
127.0.0.1   localhost
::1         localhost
127.0.1.1   Arch-WA.localdomain Arch-WA
EOF


# -------------------------------------------------------------------------
# 13  User & Root Setup
# -------------------------------------------------------------------------

sed -i '/^# %wheel ALL=(ALL:ALL) ALL/s/^# //' /etc/sudoers

useradd -mG wheel,users -s /bin/zsh willem
passwd willem


# -------------------------------------------------------------------------
# 14  mkinitcpio Basics & Plymouth
# -------------------------------------------------------------------------

sed -i 's/^MODULES=.*/MODULES=()/' /etc/mkinitcpio.conf
sed -i 's/^BINARIES=.*/BINARIES=()/' /etc/mkinitcpio.conf
sed -i 's|^HOOKS=.*|HOOKS=(base systemd autodetect microcode modconf kms keyboard sd-vconsole plymouth block sd-encrypt filesystems fsck)|' /etc/mkinitcpio.conf
sed -i 's|^#*COMPRESSION=.*|COMPRESSION="zstd"|' /etc/mkinitcpio.conf
sed -i 's|^#*COMPRESSION_OPTIONS=.*|COMPRESSION_OPTIONS="-3"|' /etc/mkinitcpio.conf

UUID=$(blkid -s UUID -o value /dev/nvme0n1p2)
cat <<EOF > /etc/kernel/cmdline
quiet splash rd.luks.name=$UUID=cryptroot rd.luks.options=tpm2-device=auto root=/dev/mapper/cryptroot rootfstype=ext4 lsm=landlock,lockdown,yama,apparmor,bpf apparmor=1
EOF

mkinitcpio -P


# -------------------------------------------------------------------------
# 15  mkinitcpio Presets & Bootloader
# -------------------------------------------------------------------------

cat <<EOF > /etc/mkinitcpio.d/linux.preset
PRESETS=('default' 'fallback')
ALL_kver="/boot/vmlinuz-linux"
default_uki="/boot/EFI/Linux/arch-linux.efi"
fallback_uki="/boot/EFI/Linux/arch-linux-fallback.efi"
fallback_options="-S autodetect"
EOF

bootctl install


# -------------------------------------------------------------------------
# 16  Pacman Hooks for sbctl Signing (UKIs)
# -------------------------------------------------------------------------

mkdir -p /etc/pacman.d/hooks
cat <<'EOF' > /etc/pacman.d/hooks/zz-sbctl-uki.hook
[Trigger]
Type = Path
Operation = Install
Operation = Upgrade
Operation = Replace
Target = /boot/EFI/Linux/*.efi

[Action]
Description = Signing UKIs with sbctl...
When = PostTransaction
Exec = /usr/bin/sbctl sign --path /boot/EFI/Linux
NeedsTargets
EOF


# -------------------------------------------------------------------------
# 17  Secure Boot & TPM2 Enrollment
# -------------------------------------------------------------------------

sbctl create-keys
sbctl enroll-keys --yes-this-might-brick-my-machine
mkinitcpio -P
sbctl sign --all
sbctl verify

systemd-cryptenroll /dev/nvme0n1p2 --recovery-key


# -------------------------------------------------------------------------
# 18  Firewall & Kernel Hardening
# -------------------------------------------------------------------------

cat <<'EOF' > /etc/nftables.conf
table inet filter {
  chain input {
    type filter hook input priority filter;
    policy drop;

    # Logging (comment out once you’re happy)
    # log prefix "nft-drop: " flags all level warning

    ct state invalid drop;
    ct state { established, related } accept;
    iifname "lo" accept;

    # ICMP (IPv4 & IPv6)
    ip protocol icmp accept;
    meta l4proto ipv6-icmp accept;

    # DHCP/DHCPv6 (client side)
    udp dport { 67, 68 } accept;
    udp dport { 546, 547 } accept;

    # mDNS on the sole Wi‑Fi interface
    ip daddr 224.0.0.251 udp dport 5353 accept;
    ip6 daddr ff02::fb udp dport 5353 accept;

    # Example rate‑limit for any future exposed TCP service
    # tcp dport { 80, 443 } ct state new limit rate 30/second burst 100 accept;
  }

  chain forward { type filter hook forward priority filter;  policy drop; }
  chain output {  type filter hook output priority filter;   policy accept; }
}
EOF

cat <<'EOF' > /etc/sysctl.d/99-hardening.conf
# --------------------------
# IP Forwarding / Routing
# --------------------------
net.ipv4.ip_forward = 0
net.ipv6.conf.all.forwarding = 0

# --------------------------
# Redirects / Source Routing
# --------------------------
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# --------------------------
# Anti-spoofing
# --------------------------
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# --------------------------
# TCP/IP protections
# --------------------------
net.ipv4.tcp_syncookies = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1

# --------------------------
# Kernel info leaks
# --------------------------
kernel.kptr_restrict = 2
kernel.dmesg_restrict = 1

# --------------------------
# Core dumps
# --------------------------
fs.suid_dumpable = 0
EOF



# -------------------------------------------------------------------------
# 19  USBGuard & MAC Randomization
# -------------------------------------------------------------------------

usbguard generate-policy | tee /etc/usbguard/rules.conf

cat <<'EOF' > /etc/usbguard/usbguard-daemon.conf
ImplicitPolicyTarget=block
PresentDevicePolicy=apply-policy
EOF

mkdir -p /etc/NetworkManager/conf.d/

cat <<EOF > /etc/NetworkManager/conf.d/20-mac-randomize.conf
[connection]
wifi.cloned-mac-address=random
ethernet.cloned-mac-address=random
EOF


# -------------------------------------------------------------------------
# 20  Disable unnecessary services
# -------------------------------------------------------------------------

systemctl disable \
  NetworkManager-dispatcher.service \
  NetworkManager-wait-online.service \
  systemd-homed-activate.service \
  systemd-homed.service \
  systemd-network-generator.service \
  systemd-networkd-wait-online.service \
  systemd-networkd.service \
  systemd-pstore.service \
  systemd-resolved.service \
  systemd-journald-audit.socket \
  systemd-mountfsd.socket \
  systemd-nsresourced.socket \
  machines.target \
  remote-integritysetup.target \
  remote-veritysetup.target


# -------------------------------------------------------------------------
# 21  Post-Reboot User & Checks
# -------------------------------------------------------------------------

su - willem
sudo passwd root -l
sudo nft list ruleset
sudo sysctl --system
sudo aa-status
sudo sbctl verify
sudo usbguard list-devices
chmod 700 /home/willem

sudo systemd-cryptenroll /dev/nvme0n1p2 --tpm2-device=auto --tpm2-with-pin=true


# -------------------------------------------------------------------------
# 22  System Cleanup
# -------------------------------------------------------------------------

sudo journalctl --rotate
sudo journalctl --vacuum-time=1s
sudo rm -rf /var/tmp/*
sudo pacman -Sc --noconfirm

